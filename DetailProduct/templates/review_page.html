{% extends 'base.html' %}
{% block content %}
{% include 'components/navbar.html' %}
{% load static %}

<div class="pb-8 min-h-screen flex flex-col w-full" style="padding-top: 80px;">
    <section class="mb-12">
    <div class="p-6 bg-white rounded-lg shadow-lg max-w-4xl mx-auto">
        <h3 class="text-xl text-gray-800 font-bold mt-6">Tambahkan Review</h3>
        <form id="review-form" method="POST">
            {% csrf_token %}
            <!-- Star Rating System -->
            <div id="star-rating" class="flex space-x-1 mb-4">
                {% for i in "12345" %}
                    <button type="button" class="star-button" data-value="{{ forloop.counter }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 .587l3.668 7.431 8.2 1.194-5.934 5.782L19.336 24 12 19.856 4.664 24l1.402-8.006L.132 9.212l8.2-1.194L12 .587z"/>
                        </svg>
                    </button>
                {% endfor %}
                <input type="hidden" id="rating" name="rating" value="0">
            </div>

            {{ form.content }}
            <button type="submit" class="bg-[#EB7C3F] hover:bg-[#d96f39] text-white font-bold py-2 px-4 rounded-full mt-4">Submit Review</button>
        </form>

        <div id="review-success" class="text-green-600 mt-4 hidden">Review successfully added!</div>

        <h2 class="text-2xl text-gray-800 font-bold mt-6">Daftar Review:</h2>
        <ul id="review-list">
            {% for review in reviews %}
                <li class="my-4 p-4 bg-gray-100 rounded-lg shadow-md flex items-start relative" data-review-id="{{ review.id }}">
                    <img src="https://www.gravatar.com/avatar/?d=mp" class="w-10 h-10 rounded-full mr-4">
            
                    <div class="flex flex-col">
                        <div class="flex items-center">
                            <h3 class="text-lg font-bold">{{ review.user.username }}</h3>
                            <span class="ml-2 text-sm text-gray-500">â€¢ {{ review.date_added|date:"d M Y" }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">Rating: <span class="font-bold">{{ review.rating }}/5</span></p>
                        <p class="text-sm text-gray-700 review-comment">{{ review.content }}</p>
                    </div>

                    {% if review.user == request.user %}
                    <div class="relative ml-auto">
                        <button class="three-dots-btn text-gray-600 hover:text-gray-900 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h.01M12 12h.01M12 18h.01" />
                            </svg>
                        </button>
            
                        <div class="edit-delete-dropdown absolute right-0 mt-2 w-32 bg-white border rounded shadow-lg hidden">
                            <a href="#" class="block px-4 py-2 text-gray-700 edit-review">Edit</a>
                            <a href="#" class="block px-4 py-2 text-red-600 delete-review hover:bg-gray-200" data-url="{% url 'DetailProduct:delete_review' review.id %}">Delete</a>
                        </div>
                    </div>
                    {% endif %}
                </li>
            {% empty %}
                <li class="my-4 empty-message">Belum ada review untuk produk ini.</li>
            {% endfor %}
        </ul>
    </div>
  </section>
</div>

<!-- Modal for Editing Review -->
<div id="editReviewModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded-lg max-w-md w-full">
        <h2 class="text-lg font-bold mb-4">Edit Review</h2>
        <form id="edit-review-form">
            {% csrf_token %}
            <input type="hidden" id="edit-review-id" name="review_id" value="">
            <div class="mb-4">
                <label for="edit-review-rating" class="block text-sm font-medium text-gray-700">Rating</label>
                <input type="number" id="edit-review-rating" name="rating" min="1" max="5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
            </div>
            <div class="mb-4">
                <label for="edit-review-comment" class="block text-sm font-medium text-gray-700">Comment</label>
                <textarea id="edit-review-comment" name="content" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></textarea>
            </div>
            <div class="flex justify-end">
                <button type="button" id="close-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancel</button>
                <button type="submit" class="bg-[#EB7C3F] hover:bg-[#d96f39] text-white font-bold py-2 px-4 rounded-md ml-2">Update Review</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editModal = document.getElementById('editReviewModal');
        
        // Star hover and click functions for creating new review
        const starButtons = document.querySelectorAll('.star-button');
        const ratingInput = document.getElementById('rating');
        
        starButtons.forEach(button => {
            button.addEventListener('mouseover', () => {
                setStarRating(button.dataset.value);
            });
            button.addEventListener('click', () => {
                ratingInput.value = button.dataset.value;
            });
        });

        function setStarRating(rating) {
            starButtons.forEach(button => {
                const svg = button.querySelector('svg');
                svg.classList.toggle('text-yellow-500', button.dataset.value <= rating);
                svg.classList.toggle('text-gray-300', button.dataset.value > rating);
            });
        }

        // Edit Review button action
        document.querySelectorAll('.edit-review').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const reviewItem = this.closest('li');
                const reviewId = reviewItem.dataset.reviewId;
                const reviewContent = reviewItem.querySelector('.review-comment').textContent;
                const reviewRating = reviewItem.querySelector('.font-bold').textContent.split('/')[0];

                document.getElementById('edit-review-id').value = reviewId;
                document.getElementById('edit-review-comment').value = reviewContent;
                document.getElementById('edit-review-rating').value = reviewRating;
                
                editModal.classList.remove('hidden');
            });
        });

        // Close modal
        document.getElementById('close-modal').addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // Submit edited review
        document.getElementById('edit-review-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            
            fetch("{% url 'DetailProduct:edit_review_ajax' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const reviewItem = document.querySelector(`li[data-review-id="${data.id}"]`);
                reviewItem.querySelector('.review-comment').textContent = data.content;
                reviewItem.querySelector('.font-bold').textContent = `${data.rating}/5`;
                editModal.classList.add('hidden');
            })
            .catch(error => alert('Failed to edit review'));
        });

        // Delete Review button action
        document.querySelectorAll('.delete-review').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const deleteUrl = this.getAttribute('data-url');
                
                if (confirm("Are you sure you want to delete this review?")) {
                    fetch(deleteUrl, {
                        method: 'GET'
                    })
                    .then(response => {
                        if (response.ok) {
                            this.closest('li').remove();
                        } else {
                            alert("Failed to delete review");
                        }
                    })
                    .catch(error => alert('Failed to delete review'));
                }
            });
        });
    });
</script>

<style>
    .star-button {
        border: none;
        background: none;
        cursor: pointer;
        padding: 0;
    }
</style>

{% endblock content %}
